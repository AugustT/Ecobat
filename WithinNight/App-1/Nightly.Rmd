---
title: "Ecobat: Nightly Bat Activity Analysis"
author: '`r params$Author`'
date: '`r strftime(Sys.time(), format = "%d/%m/%Y")`'
output: word_document
params:
  n: NA
  Author: NA
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE, comment=NULL)

#Libraries used
library(tidyverse) # Enables a consistent approach to data science
library(dplyr)
library(suncalc) # Suntimes
library(knitr)
library(lubridate)
library(ggplot2)
library(ggforce)
library(pander)
library(reshape2)


```




```{r}
# # for testing purposes - load in test data
B_data <- read.csv("//smbhome.uscs.susx.ac.uk/brs28/Desktop/MammalSociety/Ecobat/Ecobat/WithinNight/Data/RiggedHill.csv")
#glimpse(B_data)

```


```{r}
#this is here for when the script is finalised and the Shiny app is deployed
#read data in from shiny
#B_data <- params$n
```


```{r}

# Standardize Variables - make names consistent for further manipulation; can do the same for other bat sound analysis software e.g. Kaleidoscope. Make time zone local e.g `"Europe/London"`; adjusts for daylight saving automatically.


# if there is a separate column for date and time then join together to form a new column called Timestamp
if (("Date" %in% colnames(B_data) == TRUE) &
  ("Time" %in% colnames(B_data) == TRUE)) {

B_data$Timestamp <- paste(B_data$Date, B_data$Time) }

  
#Make Time Zone Local
B_data$DateTime <- lubridate::dmy_hms(B_data$Timestamp, tz = "Europe/London")

# change any instances of spec. to spp. in the species column
#B_data$Species <- stringr::str_replace(B_data$Species, "spec.", "spp." )


B_data$SppDets <- paste(B_data$Species, B_data$Detector.ID, sep = ' : ')

```


```{r}

# Create Useful Variables
# `Night` date at dusk
# `Month` month of observation `Jan, Feb, Mar....`
# `JustTime` time hh:mm of bat observation (12 hours added so plots correctly as `Night` i.e. dusk to dawn)
# `bat_time` time in seconds bat present see <https://rbats-blog.updog.co/2018/06/19/a-bat-time-metric/>


# if there is no information about the calls of the bats do this:

if ("Calls" %in% colnames(B_data) == FALSE)
   {

  B_data2 <- B_data %>% 
  mutate(Night = DateTime - lubridate::hours(12)) %>% # DateTime minus 12 hours
  mutate(Night = lubridate::as_date(Night)) %>%
  mutate(Month = lubridate::month(Night, label = T)) %>% # Make Month of observation
  mutate(JustTime = DateTime + lubridate::hours(12)) %>%
  mutate(JustTime = hms::as.hms(stringr::str_sub(as.character(JustTime), start = 12, end = 19))) %>%
  #mutate(Bat_time = (Calls * (Length + Distance)) / 1000) %>% 
  #Remove NA observations 
  filter(!is.na(Species)) %>%
  select(Night, JustTime, DateTime, Species, Month, Latitude, Longitude, Detector.ID, SppDets)
}

# if call info is provided, calculate 'Bat_time'

if ("Calls" %in% colnames(B_data) == TRUE)
   {
  B_data2 <- B_data %>% 
  mutate(Night = DateTime - lubridate::hours(12)) %>% # DateTime minus 12 hours
  mutate(Night = lubridate::as_date(Night)) %>%
  mutate(Month = lubridate::month(Night, label = T)) %>% # Make Month of observation
  mutate(JustTime = DateTime + lubridate::hours(12)) %>%
  mutate(JustTime = hms::as.hms(stringr::str_sub(as.character(JustTime), start = 12, end = 19))) %>%
  mutate(Bat_time = (Calls * (Length + Distance)) / 1000) %>% 
  #Remove NA observations 
  filter(!is.na(Species)) %>%
  select(Night, JustTime, DateTime, Species, Bat_time, Month, Latitude, Longitude, Detector.ID, SppDets)
}

     
# Change the format of the date from Y-m-d to d-m-Y:

# B_data2$Night2 <- as.Date(as.character(B_data2$Night, tz = "Europe/London", "%d/%m/%Y"), "%Y-%m-%d")
# 
# B_data2$Night2 <- format(as.Date(B_data2$Night, format = "%Y-%m-%d"), format = "%d/%m/%Y")
# 
# B_data2$Night3 <- as.Date(B_data2$Night2, format = "%d/%m/%Y")
# 
# glimpse(B_data2)
# 
# # B_data2$Night2 <- format(B_data2$Night, format=c("%d-%m-%Y"))
# # B_data2$Night2 <- as.Date(B_data2$Night, format=c("%d-%m-%Y"))


```


```{r}

# Create suntimes

# Use package `suncalcs` to make `sunset` and `sunrise` columns for each `Night` and the location (`Latitude` and `Longitude`) of the bat survey.

# Get number nights between first and last bat observation (plus 1 for dawn)
num_nights <- as.integer(difftime(max(B_data2$Night) , 
                                  min(B_data2$Night) , 
                                  units = c("days"))) + 1

# Make a date vector of nights between first and last bat observation.
nightlist <- seq.Date(from=min(B_data2$Night), 
                   length.out = num_nights +1, 
                   by='days')

# Get suntimes for date vector and Location (Latitude and Longitude)
setdata <- getSunlightTimes(date = nightlist, 
                            lat = median(B_data2$Latitude, na.rm = T), 
                            lon = median(B_data2$Longitude, na.rm = T), 
                            tz = "Europe/London")

# Duplicate data.frame to make sunrise data
risedata <- setdata

# Select  sunset date and time
setdata <- setdata %>% 
  select(date, sunset) %>% 
  mutate(date = lubridate::as_date(date))

# Select  sunrise date and time
risedata <- risedata %>% 
  select(date, sunrise) %>% 
  mutate(date = lubridate::as_date(date)) %>%
  mutate(date = date - lubridate::days(1))


# Combine sunset and risedata by 
sun_data <- dplyr::full_join(setdata, risedata, by="date")

# Rename date as Night
colnames(sun_data) <- c("Night", "sunset", "sunrise")

sun_data <- sun_data %>% 
  mutate(night_length_hr = as.numeric(difftime(sunrise, sunset, units='hours')),
         night_length_min = as.numeric(difftime(sunrise, sunset, units='mins')))


# Join bat data with the sundata by Night
joined_data <- dplyr::left_join(B_data2, sun_data, by="Night")

```


```{r}
#  ## Create Variables Relative to Suntimes and Bat Observation 
# 
#  Variables relative to suntimes and bat observation   
# 
# * `post_set_min` bat observation time minutes after sunset  
#  * `pre_rise_min` bat observation time minutes before sunrise   
#  * `post_set_hr` bat observation time hours after sunset  
#  * `pre_rise_hr` bat observation time hours before sunrise   
#  * `post_set_hr_int` bat observation time as an integer (hour) after sunset  
#      + `-0.5` to `0.49` hours is `0` hour   
#      + `0.5` to `1.49` hours is `1` hour   
#      + `1.5` to `2.49` hours is `2` hour   
#      + `2.5` to `3.49` hours is `3` hour ect...  

#  * `pre_rise_hr_int` bat observation time as an integer (hour) before sunrise  
#      + `-0.5` to `0.49` hours is `0` hour   
#      + `0.5` to `1.49` hours is `1` hour   
#      + `1.5` to `2.49` hours is `2` hour   
#      + `2.5` to `3.49` hours is `3` hour ect...   
#  * `night_length_hr`  length of the night in hours    


# To make sure difference is in minutes/hours etc... use difftime 
All_data <- joined_data %>% 
  mutate(post_set_min = as.numeric(difftime(DateTime, sunset, units='mins')),
         pre_rise_min = as.numeric(difftime(sunrise, DateTime, units='mins')),
         post_set_hr = as.numeric(difftime(DateTime, sunset, units='hours')),
         pre_rise_hr = as.numeric(difftime(sunrise, DateTime, units='hours')),
         post_set_hr_int = as.integer(round(post_set_hr, digits = 0)),
         pre_rise_hr_int = as.integer(round(pre_rise_hr, digits = 0)))

```

\newline  \newline

## Roost Emergence Time and Bat Observation

Based on: _Russ, Jon. 2012. British Bat Calls a Guide to Species Identification._ 
_Pelagic Publishing._

For more information see <https://rbats-blog.updog.co/2018/05/29/bat-emergence/>

\newline  \newline

```{r}
#Russ(2012) Bat roost emergence times minutes after sunset
Species <- c("Barbastella barbastellus",
                "Eptesicus serotinus",
                "Myotis alcathoe",
                "Myotis bechsteinii",
                "Myotis brandtii",
                "Myotis daubentonii",
                "Myotis mystacinus",
                "Myotis nattereri",
                "Myotis spp.",
                "Nyctalus leisleri",
                "Nyctalus noctula",
                "Nyctalus spp.",
                "Pipistrellus nathusii",
                "Pipistrellus pipistrellus",
                "Pipistrellus pygmaeus",
                "Pipistrellus spp.",
                "Plecotus auritus",
                "Plecotus austriacus",
                "Rhinolophus ferrumequinum",
                "Rhinolophus hipposideros")

lower <- c(25, 20, 30, 30, 30, 50, 30, 35, 30, 8, 5, 5, 18, 22, 22, 18, 40, 40, 35, 35)
upper <- c(60, 25, 35, 33, 35, 70, 35, 55, 70, 18, 9, 18, 28, 32, 28, 32, 60, 60, 48, 50)
russ <- tibble(Species, lower, upper)

```


```{r}
#Join with Jon Russ data with bat observation data All_data
All_data <- dplyr::left_join(All_data, russ, by = "Species")



# create lists to be used for tables and graphs later:

# list of all of the unique locations in the dataset
Dets <- c(unique(All_data$Detector.ID))

# list of all of the different species in the dataset
Spp_list <- unique(All_data$Species)

# list of all of the unique species-location combinations
SpDet <- c(unique(All_data$SppDets))

# dataframe of survey days 
Surv.days <- as.data.frame(unique(All_data$Night)) #all unique survey nights

Surv.days.N <- length(Surv.days$`unique(All_data$Night)`) #count of survey nights

Surv.days.M <- Surv.days %>%
mutate(Month = lubridate::month((unique(All_data$Night)), label = T)) %>%
  count(Month) #count of survey days per month


```

\newline  \newline

## Sun Times  
**The times of sunrise and sunset for each survey night, along with the length of the night in hours.**
\newline  \newline
```{r}
Table <- All_data %>% 
  select(Night, sunset, sunrise) %>% 
  distinct() %>% 
  mutate(night_length = round(as.numeric(difftime(sunrise, sunset, units='hours')), digits = 1),
         sunset = stringr::str_sub(as.character(sunset), 11, 16),
         sunrise = stringr::str_sub(as.character(sunrise), 11, 16)) %>%
  arrange(Night)

colnames(Table) <- c("Night (y-m-d)", "Sunset (hh:mm)", "Sunrise (hh:mm)", "Night Length (hours)")


knitr::kable(Table, align = "cccc")

```

\newline  \newline

***

\newline  \newline

## Counts of Bat Passes (All Detectors)

**The total number of passes recorded for each species across all of the detectors, and the percentage of recorded calls that each species constitutes.**

\newline  \newline
```{r}

# Aggregate data into Species and count

  Table <- All_data %>%
  group_by(Species) %>% 
  count() %>% 
  arrange(desc(n)) %>%
  ungroup() %>%
  mutate(Percentage = n / sum(n) *100)
  


#Change column Names so more meaningful  
colnames(Table) <- c("Species Name", "Count (No)", "Percentage (%)")

# kable is a simple table generator
knitr::kable(Table)

```


`r if(length(Dets)>1) {'\n\n *** \n\n## Counts of Bat Passes (Per Detector)\n **The total number of passes recorded for each species at each detector, and the percentage of recorded calls that each species constitutes at each detector.**\n\n' }`


```{r}

# Aggregate data into Species and count


# TO CREATE A SEPARATE TABLE FOR EACH LOCATION:

# for (i in Dets) {
# 
#   print(All_data %>%
#   filter(Detector.ID == i) %>%
#   group_by(Species, Detector.ID) %>% 
#   count() %>% 
#   arrange(desc(n)) %>%
#   ungroup() %>%
#   mutate(Percentage = n / sum(n) *100 ) %>%
#   rename(Location = Detector.ID))
#   }

if(length(Dets) >1) {


# TO CREATE A TABLE WITH LOCATION AS A COLUMN
  Table <- All_data %>%
  group_by(Species, Detector.ID) %>% 
  count() %>% 
  arrange(Detector.ID, desc(n)) %>%
  ungroup() %>%
  group_by(Detector.ID) %>%
  mutate(Percentage = n / sum(n) *100 ) %>%
  rename(Location = Detector.ID)
  


#Change column Names so more meaningful  
colnames(Table) <- c("Species Name", "Detector", "Count (No)", "Percentage by Location (%)")

# kable is a simple table generator
knitr::kable(Table, align = 'cccc')
}

```

\newline  \newline

***

\newline  \newline

## Bat Passes by Night (All Detectors)  

**The number of passes per survey night by each species, summed across all detectors.** 
\newline  \newline
```{r}
Table <- All_data %>%
  group_by(Species, Night) %>% 
  count() %>% 
  spread(Night, n)

# Make all NA's = 0
Table[is.na(Table)] <- 0


# code for having species as the rownames on the left
Table2 <- Table %>%
  remove_rownames %>%
  column_to_rownames(var="Species")

# list <- c(unique(Table$Species))
# Table3 <- as.data.frame(t(Table[,-1]))
# colnames(Table3) <- list

results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr

panderOptions('table.split.table', 120)

panderOptions('table.split.cells', 2)

pander(Table2, style = "multiline")



```


`r if(length(Dets)>1) {'\n\n***\n\n## Bat Passes by Night (By Detector)\n **The number of passes at each detector per survey night by each species.**\n\n' }`

```{r}

if(length(Dets) >1) {

Table <- All_data %>%
  group_by(SppDets, Night) %>% 
  count() %>% 
  spread(Night, n)

# Make all NA's = 0
Table[is.na(Table)] <- 0


# code for having species as the rownames on the left
Table2 <- Table %>%
  remove_rownames %>%
  column_to_rownames(var="SppDets")

# if wanting species along the top:
# list <- c(unique(Table$Species))
# Table3 <- as.data.frame(t(Table[,-1]))
# colnames(Table3) <- list

results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr

panderOptions('table.split.table', 100)
panderOptions('table.split.cells', 2)

pander(Table2, style = "multiline")

}

```


\newline  \newline

***

\newline  \newline

## Bat Passes per Hour

**This calculates the average bat passes per hour through the night by dividing the total number of bat passess for the night by the the night length (hrs) (`sunrise` - `sunset`).**

\newline  \newline
```{r}
Table <- All_data %>%
  group_by(Species, Night, night_length_hr) %>% 
  # count number of passes per night by species - makes coloumn "n""
  count() %>% 
  # calculate average bat passes per hour for each Night and species
  summarise(Act_per_hr = n / night_length_hr) %>%
  # Remove Night Length column from the Table
  select(-night_length_hr) %>% 
  spread(Night, Act_per_hr)

# Make all NA's = 0
Table[is.na(Table)] <- 0

Table2 <- Table %>% 
  remove_rownames %>% 
  column_to_rownames(var="Species")


results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr

panderOptions('table.split.table', 100)
panderOptions('round', 1)

pander(Table2, style = "multiline")

```

\newline  \newline

***

\newline  \newline

## Bat Passes per Month (All detectors)

**The total number of bat passes of each species in each month.**
*Note to me - is this useful? Needs dividing by number of survey nights I think?*

\newline  \newline
```{r}
Table <- All_data %>%
  group_by(Species, Month) %>% 
  count() %>% 
  spread(Month, n)

# Make all NA's = 0
Table[is.na(Table)] <- 0

Table2 <- Table %>% 
  remove_rownames %>% 
  column_to_rownames(var="Species")


results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr

panderOptions('table.split.table', 100)

pander(Table2, style = "rmarkdown")

```


\newline  \newline

***

\newline  \newline

## Bat Passes per Month (Per Detector) - Table

**The total number of bat passes of each species in each month at each detector.**
*Note to me - is this useful? Needs dividing by number of survey nights I think?*

\newline  \newline
```{r}
Table <- All_data %>%
  group_by(Species, Month, Detector.ID) %>% 
  count() %>% 
  spread(Month, n) %>%
  rename("Detector ID" = Detector.ID)

# Make all NA's = 0
Table[is.na(Table)] <- 0

# Table2 <- Table %>% 
#   remove_rownames %>% 
#   column_to_rownames(var="Species")


results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr

panderOptions('table.split.table', 100)

pander(Table, style = "rmarkdown")

```

\newline  \newline

***

\newline  \newline


## Bat Passes per Month (Per Detector) - Figures

```{r}

Night_month <- All_data %>%
  group_by(Species, Night, Month, Detector.ID) %>% 
  count() 



for (i in unique(All_data$Species)) {
  
print(Night_month %>%
  filter(Species == i) %>%
  ggplot(aes(Month, n)) +
  geom_boxplot(aes(fill=Detector.ID)) +
  ylab("Number of passes per night\n") +
  xlab("\nMonth") +
  ggtitle(i) +
  theme(plot.title = element_text(face = "bold.italic")))
        
}



```


\newline  \newline

***

\newline  \newline

## Bat Passes per Month (by Survey Effort)

**The average number of bat passes of each species per night throughout each month. This is calculated by taking the total number of passes each month and dividing by the number of survey nights in that month.**
*Note to self - still writing the code for this*


\newline  \newline
```{r}
Table <- All_data %>%
  group_by(Species, Month) %>% 
  count() %>% 
  spread(Month, n)

Surv.days <- as.data.frame(unique(All_data$Night))
Surv.days.t <- Surv.days %>%
mutate(Month = lubridate::month((unique(All_data$Night)), label = T)) %>%
  count(Month)



  
# Make all NA's = 0
Table[is.na(Table)] <- 0

Table2 <- Table %>% 
  remove_rownames %>% 
  column_to_rownames(var="Species")


results='asis' #important to run this as it ensures the raw table output isn't processed further by knitr

panderOptions('table.split.table', 100)

pander(Table2, style = "rmarkdown")

```


`r if("Bat_time" %in% colnames(All_data) == TRUE) {'\n\n***\n\n## Time (Seconds) Bat Present\n **Calculated from...**\n\n'}`

```{r}

if("Bat_time" %in% colnames(All_data) == TRUE) {

Table <- All_data %>%
  group_by(Night, Species) %>%
  summarise(total_act = sum(Bat_time)) %>%
  spread(Night, total_act)

# Make all NA's = ""
Table[is.na(Table)] <- 0

# simple table with 1 decimal point
knitr::kable(Table, digits = 1)

}

```


\newline  \newline

***

\newline  \newline

## Hourly Bat Passes after Sunset (All Detectors)

**The average number of bat passes per hour, for each hour after sunset.**

\newline  \newline
```{r}
Table <- All_data %>%
  group_by(Species, post_set_hr_int) %>% 
  count() %>% 
  spread(post_set_hr_int, n)

# Make all NA's = 0
Table[is.na(Table)] <- 0

# simple table
knitr::kable(Table)

```


\newline  \newline

***

\newline  \newline

## Nightly Bat Activity (By Detector)

**Timing of bat calls plotted as minutes before/after sunset, whereby 0 on the y axis represents sunset. Sunset throughout the survey period is depicted as the red dashed line.**

```{r fig.width=10, fig.height=12}

# plot out each pass 

#for(i in seq_along(SpeciesLoc)) {
  
npage <- ceiling(length(SpDet)/6)
  
for(i in seq_len(npage)) {

print(All_data %>%
  ggplot(aes(Night, post_set_min)) +
  geom_point(size=4, alpha = 0.5, position =
               position_jitter(w = 1, h = 0)) +
  geom_line(data = sun_data, aes(Night, night_length_min),
            linetype = "dashed", colour = "red") +
  xlab("\nMonth") + 
  ylab("Minutes after sunset\n") +
  theme_bw() +
  theme (legend.position = "none") +
  theme (axis.title.y = element_text(colour="black", size=18,
                                     face="bold")) +
  theme (axis.title.x = element_text(colour="black", size=18,
                                     face="bold")) +
  theme(strip.text.x = element_text(size=18, face="bold")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", linetype="solid"),
        axis.line=element_line(size=0.5, colour="black",
                               linetype="solid")) +
  theme(axis.text.x = element_text(size=16, hjust=0.5, vjust=1,
                                   colour = "black")) +
  theme(axis.text.y = element_text(size = 16, colour = "black")) +
  facet_wrap_paginate(SppDets~., ncol=2, nrow=3, scales="fixed", page=i)) 
 
}



```

\newline  \newline

***

\newline  \newline

## Bat Passes *Near* a Roost (Russ 2012) - Table

**Bat calls recorded within the time range that each species emerges from the roost are indicative of a nearby roost**

\newline  \newline
```{r}
Table <- All_data %>% 
  filter(post_set_min <= upper) %>% 
  group_by(Night, Species, Detector.ID) %>% 
  count() %>% 
  spread(Night, n) %>%
  rename("Detector ID" = Detector.ID)

# Make all NA's = 0
Table[is.na(Table)] <- 0

# simple table
knitr::kable(Table)
```

\newline  \newline

***

\newline  \newline

## Bat Passes *Near* a Roost by Night (Russ 2012) - Figures

**Bat calls recorded within the time range that each species emerges from the roost are indicative of a nearby roost. Time range for emergences are shown as grey bars and the time of each recorded call is shown. If the points overlap the grey bars, this is indicative of a nearby roost.**

\newline  \newline

```{r fig.width=22, fig.height=17}

# create a list of all of the different species
spp_list <- unique(All_data$Species)


xLab <- "\nTime after sunset (mins)"
Caption <- "\n15 minutes before and 90 minutes after sunset. \nGrey bars are emergence times adapted from (Russ 2012)"


for (i in seq_len(length(unique(All_data$Detector.ID)))) {
  
print(ggplot(All_data, aes(x=post_set_min, y=Species, colour=Species)) +
    geom_segment(aes(x=lower, xend=upper, y=Species, yend=Species),
                 size = 25, colour="grey") +
  geom_point(size=5, alpha=0.7,  position = position_jitter(height = 0.3)) +
  labs(x = xLab, caption = Caption) +
  scale_x_continuous(breaks=c(-15, 0, 15, 30, 45, 60, 75, 90),
                     limits = c(-15, 90)) +
  geom_hline(yintercept = c(seq_len(length(spp_list)-1) + 0.5),
             colour = "black", linetype = "dotted") +
  scale_y_discrete(drop=FALSE) +
  theme_bw() +
  theme(legend.position = "none") +
  theme(plot.caption = element_text(colour = "black", size = 30)) +
  theme(strip.text.x = element_text(size=30, face="bold")) +
  theme(axis.title.y = element_blank()) +
  theme(axis.title.x = element_text(colour = "black", size = 30,
                                     face = "bold")) +
  theme(axis.text.x = element_text(size = 24, hjust=0.5, vjust=1,
                                   colour = "black",
                                   face = "bold")) +
  theme(axis.text.y = element_text(size = 24, colour = "black",
                                   face = "bold.italic")) +
  theme(panel.background = element_rect(fill = "white")) +
  theme(panel.grid.major.x = element_line(colour = "black",
                                          linetype = "dotted"), 
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(), 
        panel.grid.minor.y = element_blank()) +
  theme (axis.ticks = element_blank()) +
  facet_wrap_paginate(~Detector.ID, ncol=1, nrow=1, page=i))
}


```

